# Rime TTS Provider

The Rime provider enables you to use Rime's high-quality text-to-speech models in your Life.js agent.

## Configuration

```typescript
import { Agent } from "life/agent";

const agent = new Agent({
  tts: {
    provider: "rime",
    apiKey: "your-api-key", // Or set RIME_API_KEY environment variable
    model: "arcana", // Default model
    speaker: "default", // Voice/speaker selection
    temperature: 0.5, // Controls randomness (0.0 to 2.0)
    topP: 1.0, // Controls diversity (0.0 to 1.0)
    repetitionPenalty: 1.5, // Controls repetition (0.0 to 2.0)
    maxTokens: 1200, // Maximum tokens per request (200 to 5000)
    samplingRate: 24000, // Audio sampling rate in Hz
  },
  // ... other config
});
```

## Environment Variables

Set your Rime API key as an environment variable:

```bash
export RIME_API_KEY="your-api-key"
```

## Available Models

| Model | Description | Streaming Endpoint |
|-------|-------------|-------------------|
| `arcana` | Rime's most expressive and lifelike TTS model (default) | Uses streaming PCM endpoint |
| `mistv2` | Multi-language support with enhanced features | Standard endpoint |
| `mist` | Legacy model, still supported | Standard endpoint |

## Configuration Schema

```typescript
{
  apiKey: string;           // Rime API key (required)
  model: "arcana" | "mist" | "mistv2"; // Model name (default: "arcana")
  speaker: string;          // Voice/speaker selection (default: "default")
  temperature: number;      // 0.0 to 2.0, controls randomness (default: 0.5)
  topP: number;            // 0.0 to 1.0, controls diversity (default: 1.0)
  repetitionPenalty: number; // 0.0 to 2.0, controls repetition (default: 1.5)
  maxTokens: number;       // 200 to 5000, maximum tokens per request (default: 1200)
  samplingRate: 8000 | 16000 | 22050 | 24000 | 44100 | 48000 | 96000; // Audio sampling rate (default: 24000)
  baseUrl: string;         // API base URL (default: https://users.rime.ai/v1)
}
```

## Audio Format

The Rime provider returns audio in PCM format:
- **Format**: 16-bit signed PCM
- **Channels**: Mono
- **Sample Rate**: Configurable (8kHz to 96kHz)
- **Data Type**: Int16Array for efficient processing

## Features

- ✅ Streaming audio synthesis
- ✅ High-quality, expressive speech
- ✅ Multiple voice options
- ✅ Low latency streaming
- ✅ Emotional depth and naturalness
- ✅ Fine-grained control over prosody
- ✅ Configurable audio quality (8kHz to 96kHz)
- ✅ Incremental text processing
- ✅ PCM audio format for real-time applications

## Getting Started

1. **Get your API key**: Visit [rime.ai](https://rime.ai) to obtain your Rime API key
2. **Set environment variable**: `export RIME_API_KEY="your-key-here"`
3. **Configure your agent**: Use the configuration example above
4. **Start building**: Your agent is now ready to use Rime TTS!

## Example Usage

```typescript
import { Agent } from "life/agent";

const agent = new Agent({
  tts: {
    provider: "rime",
    model: "arcana",
    speaker: "default",
    temperature: 0.7,
    topP: 0.8,
    samplingRate: 24000, // High quality audio
  },
});

// The agent will now use Rime TTS for all speech synthesis
```

## Voice Selection

Rime offers a diverse set of voices across different demographics, ages, and styles. You can:

- Use default voices by setting `speaker: "default"`
- Use descriptive names like `speaker: "gen z woman"`
- Use specific voice IDs from Rime's voice catalog

## Model Selection Guide

- **arcana**: Best for most use cases, highly expressive and natural. Uses optimized streaming PCM endpoint for faster response times.
- **mistv2**: Great for multi-language applications
- **mist**: Legacy model for compatibility

## Advanced Configuration

### Audio Quality Settings
Choose sampling rate based on your needs:
- `8000`: Phone quality, smallest bandwidth
- `16000`: Standard voice quality
- `24000`: High quality (default), good balance
- `44100`: CD quality
- `48000`: Professional audio
- `96000`: Ultra-high quality, largest bandwidth

### Temperature Control
- `0.0`: Very deterministic, consistent output
- `0.5`: Balanced (default)
- `2.0`: More creative and varied

### Top-P Sampling
- `0.1`: More focused, conservative
- `1.0`: Full diversity (default)
- Values between 0.1-1.0: Balanced control

### Repetition Penalty
- `1.0`: No penalty
- `1.5`: Moderate penalty (default)
- `2.0`: Strong penalty against repetition

### Token Limits
- `200`: Minimum tokens per request
- `1200`: Default, good for most use cases
- `5000`: Maximum tokens, for longer text synthesis

## Technical Implementation

### Streaming Behavior
- **Arcana model**: Uses dedicated streaming PCM endpoint for optimal performance
- **Other models**: Use standard TTS endpoint
- **Audio processing**: Real-time PCM conversion to Int16Array
- **Incremental processing**: Handles text chunks efficiently with context preservation

### Job Management
- Automatic abort controller management
- Incremental text tracking per job
- Stream coordination to prevent overlapping requests
- Clean resource cleanup on job completion

## Error Handling

The provider handles common errors gracefully:

- **Invalid API key**: Throws configuration error with clear message
- **Network issues**: Retries with exponential backoff
- **Rate limiting**: Respects API rate limits
- **Streaming errors**: Properly closes connections and cleans up resources
- **Abort handling**: Clean cancellation of ongoing requests

## Performance Notes

- Streaming starts in 200-300ms regardless of text length
- Optimized for real-time applications with PCM audio format
- Supports cancellation of ongoing requests
- Efficient memory usage with streaming audio chunks
- Context-aware incremental text processing reduces redundant API calls
- Automatic sampling rate optimization based on model capabilities